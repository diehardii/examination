试卷
package seucxxy.csd.backend.entity;



import java.util.List;

public class ExamPaper {
    private Long id;
    private String examPaperName;
    private String examPaperContent;
    private String examPaperDifficulty;
    private int examPaperQuestionNumber;
    private String examPaperSubject;
    private List<Question> questions;

    // Getters and Setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getExamPaperName() {
        return examPaperName;
    }

    public void setExamPaperName(String examPaperName) {
        this.examPaperName = examPaperName;
    }

    public String getExamPaperContent() {
        return examPaperContent;
    }

    public void setExamPaperContent(String examPaperContent) {
        this.examPaperContent = examPaperContent;
    }

    public String getExamPaperDifficulty() {
        return examPaperDifficulty;
    }

    public void setExamPaperDifficulty(String examPaperDifficulty) {
        this.examPaperDifficulty = examPaperDifficulty;
    }

    public int getExamPaperQuestionNumber() {
        return examPaperQuestionNumber;
    }

    public void setExamPaperQuestionNumber(int examPaperQuestionNumber) {
        this.examPaperQuestionNumber = examPaperQuestionNumber;
    }

    public String getExamPaperSubject() {
        return examPaperSubject;
    }

    public void setExamPaperSubject(String examPaperSubject) {
        this.examPaperSubject = examPaperSubject;
    }

    public List<Question> getQuestions() {
        return questions;
    }

    public void setQuestions(List<Question> questions) {
        this.questions = questions;
    }
}
题目
package seucxxy.csd.backend.entity;



public class Question {
    private Long id;
    private String questionType; // 新增字段，对应数据库question_type
    private String type;
    private String content;
    private int number;
    private Long examPaperId;
    private String correctAnswer; // 移动到基类

    // Getters and Setters
    // 添加questionType的getter/setter
    public String getQuestionType() {
        return questionType;
    }

    public void setQuestionType(String questionType) {
        this.questionType = questionType;
    }

    // Getters and Setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public int getNumber() {
        return number;
    }

    public void setNumber(int number) {
        this.number = number;
    }

    public Long getExamPaperId() {
        return examPaperId;
    }

    public void setExamPaperId(Long examPaperId) {
        this.examPaperId = examPaperId;
    }


    public String getCorrectAnswer() {
        return correctAnswer;
    }

    public void setCorrectAnswer(String correctAnswer) {
        this.correctAnswer = correctAnswer;
    }
}
单选题
package seucxxy.csd.backend.entity;



public class SingleChoiceQuestion extends Question {
    private String optionA;
    private String optionB;
    private String optionC;
    private String optionD;


    // Getters and Setters
    public String getOptionA() {
        return optionA;
    }

    public void setOptionA(String optionA) {
        this.optionA = optionA;
    }

    public String getOptionB() {
        return optionB;
    }

    public void setOptionB(String optionB) {
        this.optionB = optionB;
    }

    public String getOptionC() {
        return optionC;
    }

    public void setOptionC(String optionC) {
        this.optionC = optionC;
    }

    public String getOptionD() {
        return optionD;
    }

    public void setOptionD(String optionD) {
        this.optionD = optionD;
    }

}
判断题
package seucxxy.csd.backend.entity;



public class JudgeQuestion extends Question {



}

用户所有的试卷
package seucxxy.csd.backend.entity;


public class UserExamPaper {
    private Long id;
    private Long examPaperId;
    private String username;

    // Getters and Setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getExamPaperId() {
        return examPaperId;
    }

    public void setExamPaperId(Long examPaperId) {
        this.examPaperId = examPaperId;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }
}

用户考试记录
package seucxxy.csd.backend.entity;



import java.time.LocalDateTime;

public class UserTestRecord {
    private Long testId;
    private int correctNumber;
    private int testScore;
    private LocalDateTime testTime;
    private Long examPaperId;
    private Long userId;

    private ExamPaper examPaper;
    // Getters and Setters
    public Long getTestId() {
        return testId;
    }

    public void setTestId(Long testId) {
        this.testId = testId;
    }

    public int getCorrectNumber() {
        return correctNumber;
    }

    public void setCorrectNumber(int correctNumber) {
        this.correctNumber = correctNumber;
    }

    public int getTestScore() {
        return testScore;
    }

    public void setTestScore(int testScore) {
        this.testScore = testScore;
    }

    public LocalDateTime getTestTime() {
        return testTime;
    }

    public void setTestTime(LocalDateTime testTime) {
        this.testTime = testTime;
    }

    public Long getExamPaperId() {
        return examPaperId;
    }

    public void setExamPaperId(Long examPaperId) {
        this.examPaperId = examPaperId;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }

    // 新增的ExamPaper getter和setter
    public ExamPaper getExamPaper() {
        return examPaper;
    }

    public void setExamPaper(ExamPaper examPaper) {
        this.examPaper = examPaper;
    }
}
用户考试记录详情
package seucxxy.csd.backend.entity;




public class UserTestRecordDetail {
    private Long id;
    private String correctAnswer;
    private int questionNumber;
    private String questionType;
    private String userAnswer;
    private Long testId;

    // Getters and Setters
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getCorrectAnswer() {
        return correctAnswer;
    }

    public void setCorrectAnswer(String correctAnswer) {
        this.correctAnswer = correctAnswer;
    }

    public int getQuestionNumber() {
        return questionNumber;
    }

    public void setQuestionNumber(int questionNumber) {
        this.questionNumber = questionNumber;
    }

    public String getQuestionType() {
        return questionType;
    }
    public void setQuestionType(String questionType) {
        this.questionType = questionType;
    }

    public String getUserAnswer() {
        return userAnswer;
    }
    public void setUserAnswer(String userAnswer) {
        this.userAnswer = userAnswer;
    }

    public Long getTestId() {
        return testId;
    }
    public void setTestId(Long testId) {
        this.testId= testId;
    }

}
试卷服务类
package seucxxy.csd.backend.service;

import org.springframework.beans.factory.annotation.Autowired;
import seucxxy.csd.backend.entity.*;
import seucxxy.csd.backend.mapper.ExamPaperMapper;
import seucxxy.csd.backend.mapper.QuestionMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;

import java.util.ArrayList;
import java.util.List;

@Service
@Transactional
public class ExamPaperService {
    private final ExamPaperMapper examPaperMapper;
    private final QuestionMapper questionMapper;
    private final RestTemplate restTemplate;

    @Value("${coze.api.url}")
    private String cozeApiUrl;

    @Value("${coze.api.token.paper.gen}")
    private String cozeApiToken;

    @Autowired
    public ExamPaperService(ExamPaperMapper examPaperMapper,
                            QuestionMapper questionMapper,
                            RestTemplate restTemplate) {
        this.examPaperMapper = examPaperMapper;
        this.questionMapper = questionMapper;
        this.restTemplate = restTemplate;
    }



    public ExamPaper getExamPaperByIdWithQuestions(Long id) {
        return examPaperMapper.findExamPaperByIdWithQuestions(id);
    }

    public List<ExamPaper> getAvailableExamPapers(String username) {
        return examPaperMapper.findAvailableExamPapers(username);
    }

    @Transactional
    public ExamPaper generateExamPaper(String name, String content, String difficulty, String subject) throws Exception {
        // 检查试卷名称是否已存在
        ExamPaper existingPaper = examPaperMapper.findExamPaperByName(name);
        if (existingPaper != null) {
            throw new Exception("试卷名称已存在");
        }

        // 构建请求到Coze API
        String requestBody = String.format("{\"workflow_id\": \"7504502289714069538\", \"parameters\": {\"content\": \"%s\", \"difficulty\": \"%s\"}}",
                content, difficulty);
        System.out.println(requestBody);

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("Authorization", "Bearer " + cozeApiToken);

        HttpEntity<String> requestEntity = new HttpEntity<>(requestBody, headers);
        ResponseEntity<String> response = restTemplate.exchange(cozeApiUrl, HttpMethod.POST, requestEntity, String.class);

        // 解析响应
        ObjectMapper mapper = new ObjectMapper();
        JsonNode rootNode = mapper.readTree(response.getBody());
        String dataValue = rootNode.path("data").asText();
        JsonNode dataNode = mapper.readTree(dataValue);

        // 解析问题
        String questionsJson = dataNode.get("questions").asText();
        List<Question> questions = parseQuestions(questionsJson);

        // 创建并保存试卷
        ExamPaper examPaper = new ExamPaper();
        examPaper.setExamPaperName(name);
        examPaper.setExamPaperContent(content);
        examPaper.setExamPaperDifficulty(difficulty);
        examPaper.setExamPaperQuestionNumber(questions.size());
        examPaper.setExamPaperSubject(subject);

        examPaperMapper.insertExamPaper(examPaper);

        // 保存问题
        batchInsertQuestions(questions, examPaper.getId());

        // 设置关联关系
        examPaper.setQuestions(questions);
        return examPaper;
    }

    public void batchInsertQuestions(List<Question> questions, Long examPaperId) {
        if (questions == null || questions.isEmpty()) {
            System.out.println("题目列表为空，无需插入");
            return;
        }

        int successCount = 0;

        for (Question question : questions) {
            try {
                // 设置试卷ID
                question.setExamPaperId(examPaperId);

                // 插入主表
                int result = questionMapper.insertQuestion(question);

                if (result > 0) {
                    successCount++;
                    // 根据不同类型打印不同信息
                    if (question.getQuestionType().equals("SINGLE_CHOICE")) {
                        SingleChoiceQuestion scq = (SingleChoiceQuestion) question;
                        System.out.printf("成功插入单选题: ID=%d, 内容=%s, 选项A=%s, 正确答案=%s%n",
                                question.getId(), question.getContent(),
                                scq.getOptionA(), question.getCorrectAnswer());
                    } else if (question.getQuestionType().equals("JUDGE")) {
                        System.out.printf("成功插入判断题: ID=%d, 内容=%s, 正确答案=%s%n",
                                question.getId(), question.getContent(),
                                question.getCorrectAnswer());
                    }
                } else {
                    System.out.println("插入失败: " + question.getContent());
                }
            } catch (Exception e) {
                System.out.println("插入题目异常: " + question.getContent() + ", 错误: " + e.getMessage());
                e.printStackTrace();
            }
        }

        System.out.printf("插入完成! 成功插入%d条，共%d条%n", successCount, questions.size());
    }

    private List<Question> parseQuestions(String questionsJson) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        JsonNode questionsNode = mapper.readTree(questionsJson);
        List<Question> questions = new ArrayList<>();

        for (JsonNode questionNode : questionsNode) {
            String type = questionNode.path("type").asText();
            String content = questionNode.path("question").asText();
            int number = questionNode.path("number").asInt();

            if ("单选题".equals(type)) {
                SingleChoiceQuestion scq = new SingleChoiceQuestion();
                scq.setType(type);
                scq.setQuestionType("SINGLE_CHOICE");
                scq.setContent(content);
                scq.setNumber(number);
                scq.setOptionA(questionNode.path("optionA").asText());
                scq.setOptionB(questionNode.path("optionB").asText());
                scq.setOptionC(questionNode.path("optionC").asText());
                scq.setOptionD(questionNode.path("optionD").asText());
                scq.setCorrectAnswer(questionNode.path("correctAnswer").asText());

                questions.add(scq);
            } else if ("是非题".equals(type)) {
                JudgeQuestion jq = new JudgeQuestion();
                jq.setType(type);
                jq.setQuestionType("JUDGE");
                jq.setContent(content);
                jq.setNumber(number);
                jq.setCorrectAnswer(questionNode.path("correctAnswer").asText());
                questions.add(jq);
            }
        }
        System.out.println(questions.toString());
        return questions;
    }
}
试题服务类
package seucxxy.csd.backend.service;

import org.springframework.stereotype.Service;
import seucxxy.csd.backend.entity.*;
import seucxxy.csd.backend.mapper.*;

import java.util.List;


@Service
public class QuestionService {

    private final QuestionMapper questionMapper;

    public QuestionService(QuestionMapper questionMapper) {
           this.questionMapper = questionMapper;
    }

      public List<Question> getQuestionsByExamPaperId(long examPaperId) {
        return questionMapper.findQuestionsByExamPaperId(examPaperId);
    }

    public Question getQuestionByExamPaperIdAndNumber(long examPaperId, int number) {
        return questionMapper.findQuestionByExamPaperIdAndNumber(examPaperId, number);
    }


}
用户试卷关系服务类
package seucxxy.csd.backend.service;

import seucxxy.csd.backend.entity.*;
import seucxxy.csd.backend.mapper.*;

import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import java.util.List;

@Service
public class UserExamPaperService {
    private final ExamPaperMapper examPaperMapper;
    private final UserExamPaperMapper userExamPaperMapper;
    private final RestTemplate restTemplate;



    public UserExamPaperService(ExamPaperMapper examPaperMapper,
                                UserExamPaperMapper userExamPaperMapper,
                                RestTemplate restTemplate) {
        this.examPaperMapper = examPaperMapper;
        this.userExamPaperMapper = userExamPaperMapper;
        this.restTemplate = restTemplate;
    }


    public List<ExamPaper> getUserExamPapers(String username) {
        return userExamPaperMapper.findExamPapersByUsername(username);
    }
    public void saveUserExamPapers(String username, List<Long> examPaperIds) {
        // 先删除用户原有的试卷关系
        userExamPaperMapper.deleteByUsername(username);

        // 添加新的试卷关系
        examPaperIds.forEach(examPaperId -> {
            UserExamPaper userExamPaper = new UserExamPaper();
            userExamPaper.setExamPaperId(examPaperId);
            userExamPaper.setUsername(username);
            userExamPaperMapper.insert(userExamPaper);
        });
    }

}
用户考试记录服务类
package seucxxy.csd.backend.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import seucxxy.csd.backend.entity.*;
import seucxxy.csd.backend.mapper.ExamPaperMapper;
import seucxxy.csd.backend.mapper.UserTestRecordDetailMapper;
import seucxxy.csd.backend.mapper.UserTestRecordMapper;

import java.util.List;
import java.util.Map;

@Service
public class UserTestRecordService {

    @Autowired
    private ExamPaperMapper examPaperMapper;
    @Autowired
    private UserTestRecordMapper userTestRecordMapper;

    @Autowired
    private UserTestRecordDetailMapper userTestRecordDetailMapper;

    public void saveTestRecord(UserTestRecord record, List<Question> questions,
                               Map<Integer, String> singleChoiceAnswers,
                               Map<Integer, String> judgeAnswers) {
        // 保存主记录
        userTestRecordMapper.insertUserTestRecord(record);

        // 保存详细记录
        for (Question q : questions) {
            UserTestRecordDetail detail = new UserTestRecordDetail();
            detail.setTestId(record.getTestId());
            detail.setQuestionNumber(q.getNumber());
            detail.setQuestionType(q instanceof SingleChoiceQuestion ? "SINGLE_CHOICE" : "JUDGE");
            detail.setCorrectAnswer(q.getCorrectAnswer());

            if (q instanceof SingleChoiceQuestion) {
                detail.setUserAnswer(singleChoiceAnswers.get(q.getNumber()));
                System.out.println("userAnswer"+singleChoiceAnswers.get(q.getNumber()));
            } else if (q instanceof JudgeQuestion) {
                detail.setUserAnswer(judgeAnswers.get(q.getNumber()));
                System.out.println("userAnswer"+judgeAnswers.get(q.getNumber()));
            }

            System.out.println("detail"+detail.getUserAnswer());
            userTestRecordDetailMapper.insertUserTestRecordDetail(detail);
        }
    }

    public List<UserTestRecord> getUserTestRecordsByUsername(String username) {
        List<UserTestRecord> records = userTestRecordMapper.findUserTestRecordsByUsernameOrderByTestTimeDesc(username);

        // 2. 为每条记录加载关联的ExamPaper
        records.forEach(record -> {
            if (record.getExamPaperId() != null) {
                ExamPaper paper = examPaperMapper.findExamPaperById(record.getExamPaperId());
                record.setExamPaper(paper);
            }
        });

        return records;
    }


    public List<UserTestRecord> getUserTestRecordsByUsernameAndSubject(String username, String subject) {
        return userTestRecordMapper.findUserTestRecordsByUsernameAndSubject(username, subject);
    }



}



试卷分析控制器
package seucxxy.csd.backend.controller;


import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import seucxxy.csd.backend.entity.User;
import seucxxy.csd.backend.entity.UserTestRecord;
import seucxxy.csd.backend.service.PaperAnaService;
import seucxxy.csd.backend.service.SubjectService;
import seucxxy.csd.backend.service.UserTestRecordService;

import java.util.List;

@Controller
@RequestMapping("/exam-paper")
public class PaperAnaController {

    private final PaperAnaService paperAnaService;
    private final SubjectService subjectService;
    private final UserTestRecordService userTestRecordService;

    public PaperAnaController(PaperAnaService paperAnaService, SubjectService subjectService, UserTestRecordService userTestRecordService) {
        this.paperAnaService = paperAnaService;
        this.subjectService = subjectService;
        this.userTestRecordService = userTestRecordService;
    }

    @GetMapping("/paper-ana")
    public String showSubjectAnalysisPage(HttpSession session,
                                          Model model) {
        User user = (User) session.getAttribute("user");
        String username = user.getUsername();

        List<String> subjects = subjectService.getSubjectsForUser(username);

        model.addAttribute("subjects", subjects);
        model.addAttribute("username", username);
        model.addAttribute("user", user);

        return "exam-paper/paper-ana";
    }

    @GetMapping("/records")
    @ResponseBody
    public String getExamRecords(@RequestParam String subject,
                                 @AuthenticationPrincipal UserDetails userDetails) {
        String username = userDetails.getUsername();
        List<UserTestRecord> records = userTestRecordService.getUserTestRecordsByUsernameAndSubject(username, subject);

        if (records.isEmpty()) {
            return "<tr><td colspan='4' style='text-align:center;'>暂无记录</td></tr>";
        }

        StringBuilder html = new StringBuilder();
        for (UserTestRecord record : records) {
            html.append("<tr data-record-id='").append(record.getTestId()).append("'>")
                    .append("<td>").append(record.getExamPaper().getExamPaperName()).append("</td>")
                    .append("<td>").append(record.getTestTime()).append("</td>")
                    .append("<td>").append(record.getTestScore()).append("</td>")
                    .append("<td>").append(record.getCorrectNumber()).append("</td>")
                    .append("</tr>");
        }

        return html.toString();
    }

    @PostMapping("/paper-ana-result")
    public String analyzeSubject(@RequestParam String subject,
                                 HttpSession session,
                                 Model model) {
        User user = (User) session.getAttribute("user");
        String username = user.getUsername();

        String analysisResult = paperAnaService.analyzeSubject(username, subject);

        model.addAttribute("subject", subject);
        model.addAttribute("analysisResult", analysisResult);
        model.addAttribute("user", user);

        return "exam-paper/paper-ana-result";
    }
}
试卷分析服务类
package seucxxy.csd.backend.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import seucxxy.csd.backend.entity.*;
import seucxxy.csd.backend.mapper.*;

import java.util.*;

@Service
public class PaperAnaService {
    private final UserTestRecordMapper userTestRecordMapper;
    private final QuestionMapper questionMapper;
    private final RestTemplate restTemplate;
    private final ObjectMapper objectMapper;
    private final UserTestRecordDetailMapper userTestRecordDetailMapper;

    public PaperAnaService(UserTestRecordMapper userTestRecordMapper,
                           QuestionMapper questionMapper,
                           RestTemplateBuilder restTemplateBuilder,
                           ObjectMapper objectMapper,
                           UserTestRecordDetailMapper userTestRecordDetailMapper) {
        this.userTestRecordMapper = userTestRecordMapper;
        this.questionMapper = questionMapper;
        this.restTemplate = restTemplateBuilder.build();
        this.objectMapper = objectMapper;
        this.userTestRecordDetailMapper = userTestRecordDetailMapper;
    }


    public String analyzeSubject(String username, String subject) {
        String examResultsJson = getExamResultsJson(username, subject);
        return callCozeAnalysisApi(examResultsJson);
    }

    private String getExamResultsJson(String username, String subject) {
        List<Map<String, Object>> examResults = new ArrayList<>();

        List<UserTestRecord> records = userTestRecordMapper.findUserTestRecordsByUsernameAndSubject(username, subject);

        for (UserTestRecord record : records) {
            // 获取单选题
            List<SingleChoiceQuestion> singleChoiceQuestions =
                    questionMapper.findSCByExamPaperId(record.getExamPaper().getId());

            for (SingleChoiceQuestion question : singleChoiceQuestions) {
                Map<String, Object> questionData = new HashMap<>();
                questionData.put("question", question.getContent());

                List<Map<String, String>> options = new ArrayList<>();
                options.add(Map.of("label", "A", "text", question.getOptionA()));
                options.add(Map.of("label", "B", "text", question.getOptionB()));
                options.add(Map.of("label", "C", "text", question.getOptionC()));
                options.add(Map.of("label", "D", "text", question.getOptionD()));

                questionData.put("options", options);
                questionData.put("correctAnswer", question.getCorrectAnswer());

                // 查找用户答案
                Optional<UserTestRecordDetail> detail = userTestRecordDetailMapper.findUserTestRecordDetailsByTestId(record.getTestId()).stream()
                        .filter(d -> d.getQuestionNumber() == question.getNumber() &&
                                "SINGLE_CHOICE".equals(d.getQuestionType()))
                        .findFirst();

                questionData.put("userAnswer", detail.map(UserTestRecordDetail::getUserAnswer).orElse(""));

                examResults.add(questionData);
            }

            // 获取判断题
            List<JudgeQuestion> judgeQuestions =
                    questionMapper.findJQByExamPaperId(record.getExamPaper().getId());

            for (JudgeQuestion question : judgeQuestions) {
                Map<String, Object> questionData = new HashMap<>();
                questionData.put("question", question.getContent());
                questionData.put("correctAnswer", question.getCorrectAnswer());

                Optional<UserTestRecordDetail> detail = userTestRecordDetailMapper.findUserTestRecordDetailsByTestRecordId(record.getTestId()).stream()
                        .filter(d -> d.getQuestionNumber() == question.getNumber() &&
                                "JUDGE".equals(d.getQuestionType()))
                        .findFirst();

                questionData.put("userAnswer", detail.map(UserTestRecordDetail::getUserAnswer).orElse(""));

                examResults.add(questionData);
            }
        }

        try {
            return objectMapper.writeValueAsString(examResults);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Failed to serialize exam results", e);
        }
    }

    private String callCozeAnalysisApi(String examResultsJson) {
        // 清理JSON字符串
        String cleanJson = examResultsJson
                .replaceAll("\\s+", "")
                .replaceAll("\"", "")
                .replaceAll("[{}[\\\\]]", "");

        // 构建请求体
        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("workflow_id", "7506799894930407458");

        Map<String, String> parameters = new HashMap<>();
        parameters.put("examResult", cleanJson);
        requestBody.put("parameters", parameters);

        // 设置请求头
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("Authorization", "Bearer pat_o7F5c01q3jOb5NKbVHmmRG22wz1GWRBuahZLeJS7nb7K9WbsaeugCn43TDx0eOxL");

        // 发送请求
        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(requestBody, headers);
        ResponseEntity<String> response = restTemplate.exchange(
                "https://api.coze.cn/v1/workflow/run",
                HttpMethod.POST,
                entity,
                String.class
        );

        // 解析响应
        try {
            JsonNode rootNode = objectMapper.readTree(response.getBody());
            String dataValue = rootNode.path("data").asText();

            // 提取分析结果
            return dataValue.replaceAll(".*\"analysis\":\"", "")
                    .replaceAll("\"}$", "")
                    .replace("\\n", "<br/>");
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Failed to parse Coze API response", e);
        }
    }
}
考试科目分析，分析一个科目的所有考试卷
<!-- src/main/resources/templates/subject-analysis.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>考试科目分析</title>
  <link rel="stylesheet" th:href="@{/css/menuStyle.css}">
  <style>
    /* 全局设置 - 蓝色系 */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      height: 100vh;
      background-color: #0f1a2c;
      color: #e0e0ff;
    }

    .sidebar {
      width: 250px;
      background-color: #162447;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: fixed;
      left: 0;
      top: 0;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .sidebar h2 {
      text-align: center;
      padding: 20px;
      font-size: 22px;
      letter-spacing: 1px;
      border-bottom: 1px solid #2d3436;
      margin-bottom: 30px;
    }

    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }

    .menu li {
      padding: 15px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
    }

    .menu li:hover {
      background-color: #1f4068;
    }

    .menu li a {
      color: white;
      text-decoration: none;
      display: block;
    }

    .content {
      margin-left: 250px;
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      background-color: #1a2535;
    }

    .header {
      font-size: 28px;
      color: #dfe6e9;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .card {
      background-color: #1f3a6f;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-width: 100%;
      margin: auto;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* 表格容器样式 */
    .paper-container {
      display: flex;
      margin-top: 20px;
      gap: 20px;
    }

    .subject-list {
      width: 40%;
      height: 400px;
      overflow: auto;
      border: 1px solid #ddd;
      background-color: #f0f8ff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
      box-sizing: border-box;
    }

    .exam-record-list {
      width: 60%;
      height: 400px;
      overflow: auto;
      border: 1px solid #ddd;
      background-color: #f0f8ff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
      box-sizing: border-box;
    }

    .paper-section {
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }

    /* 表格样式 */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      table-layout: auto;
    }

    /* 表头样式 */
    thead tr {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f3e5ff !important;
      background-image: linear-gradient(to bottom, #f3e5ff, #e6d1f9);
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    thead th {
      padding: 12px 15px;
      text-align: left;
      background-color: #f8f9fa;
      color: #003366;
      font-weight: 600;
      border-bottom: 2px solid #d8bfd8;
      white-space: nowrap;
    }

    /* 内容行样式 */
    tbody tr {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    tbody tr td {
      padding: 12px 15px;
      border-bottom: 1px solid #dee2e6;
      color: #333;
    }

    /* 高亮样式 */
    tbody tr.highlight {
      background-color: #e6f7ff !important;
      color: #003366 !important;
    }

    tbody tr:hover:not(.highlight) {
      background-color: #f8f9fa;
    }

    /* 提交按钮容器 */
    .submit-btn-container {
      display: block;
      width: 40%;
      text-align: center;
      margin-top: 20px;
    }

    .submit-btn {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
      display: inline-block;
    }

    .submit-btn:hover {
      background-color: #45a049;
    }

    /* 滚动条样式 */
    .subject-list::-webkit-scrollbar,
    .exam-record-list::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .subject-list::-webkit-scrollbar-track,
    .exam-record-list::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .subject-list::-webkit-scrollbar-thumb,
    .exam-record-list::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .subject-list::-webkit-scrollbar-thumb:hover,
    .exam-record-list::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
  <script>
    // 当前选中的科目
    var selectedSubject = null;

    // 高亮选中的行并记录选中的科目
    function highlightRow(row, subject) {
      // 获取表格的tbody
      var tbody = row.parentNode;

      // 移除该表格中之前的高亮
      var rows = tbody.getElementsByTagName('tr');
      for (var i = 0; i < rows.length; i++) {
        rows[i].classList.remove('highlight');
      }

      // 添加新的高亮
      row.classList.add('highlight');

      // 更新选中的科目
      selectedSubject = subject;
      document.getElementById('selectedSubject').value = subject;

      // 加载该科目的考试记录
      loadExamRecords(subject);
    }

    // 加载考试记录
    function loadExamRecords(subject) {
      var username = document.getElementById('currentUser').value;
      var examRecordsTable = document.getElementById('examRecordsTable');

      // 显示加载中状态
      examRecordsTable.innerHTML = `
        <tr>
          <td colspan="4" style="text-align:center;">加载中...</td>
        </tr>
      `;

      // 使用AJAX获取考试记录
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/exam-paper/records?subject=' + encodeURIComponent(subject), true);
      xhr.setRequestHeader('Content-Type', 'application/json');

      xhr.onload = function() {
        if (xhr.status === 200) {
          examRecordsTable.innerHTML = xhr.responseText;

          // 如果没有记录，显示提示信息
          if (examRecordsTable.innerHTML.trim() === '') {
            examRecordsTable.innerHTML = `
              <tr>
                <td colspan="4" style="text-align:center;">暂无记录</td>
              </tr>
            `;
          }
        } else {
          examRecordsTable.innerHTML = `
            <tr>
              <td colspan="4" style="text-align:center;">加载失败</td>
            </tr>
          `;
          console.error('加载考试记录失败');
        }
      };
      xhr.send();
    }

    // 页面加载时初始化
    window.onload = function() {
      // 为所有科目行添加点击事件
      var subjectRows = document.querySelectorAll('#subjectTable tbody tr');
      subjectRows.forEach(function(row) {
        var subject = row.getAttribute('data-subject') || row.cells[0].textContent;
        row.onclick = function() { highlightRow(this, subject); };
      });

      // 默认选中第一行（如果有数据）
      if (subjectRows.length > 0) {
        var firstRow = subjectRows[0];
        var firstSubject = firstRow.getAttribute('data-subject') || firstRow.cells[0].textContent;
        highlightRow(firstRow, firstSubject);
      }

      // 表单提交前检查是否有选中项
      document.getElementById('analysisForm').addEventListener('submit', function(e) {
        if (!selectedSubject) {
          alert('请先选择一个科目！');
          e.preventDefault();
        }
      });
    }
  </script>
</head>
<body>
<div th:replace="fragments/menu :: menu"></div>

<!-- 右侧内容区域 -->
<div class="content">
  <h1 class="header">请选择需要分析的科目</h1>

  <div class="paper-container">
    <!-- 科目列表 -->
    <div class="subject-list">
      <table id="subjectTable">
        <thead>
        <tr>
          <th>科目名称</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="subject : ${subjects}" th:data-subject="${subject}">
          <td th:text="${subject}"></td>
        </tr>
        <tr th:if="${subjects.isEmpty()}">
          <td colspan="1">没有找到相关科目</td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- 考试记录列表 -->
    <div class="exam-record-list">
      <table>
        <thead>
        <tr>
          <th>试卷名称</th>
          <th>考试时间</th>
          <th>得分</th>
          <th>正确题数</th>
        </tr>
        </thead>
        <tbody id="examRecordsTable">
        <tr>
          <td colspan="4" style="text-align:center;">请选择左侧科目查看考试记录</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 分析按钮 -->
  <div class="submit-btn-container">
    <form id="analysisForm" th:action="@{/exam-paper/paper-ana-result}" method="post">
      <input type="hidden" id="selectedSubject" name="subject" value="">
      <input type="hidden" id="currentUser" th:value="${username}">
      <button type="submit" class="submit-btn">分析</button>
    </form>
  </div>
</div>
</body>
</html>
分析后的返回结果
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>考试科目分析结果</title>
    <link rel="stylesheet" th:href="@{/css/menuStyle.css}">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            background-color: #0f1a2c;
            color: #e0e0ff;
        }

        .sidebar {
            width: 250px;
            background-color: #162447;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            padding: 20px;
            font-size: 22px;
            letter-spacing: 1px;
            border-bottom: 1px solid #2d3436;
            margin-bottom: 30px;
        }

        .menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
        }

        .menu li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 16px;
        }

        .menu li:hover {
            background-color: #1f4068;
        }

        .menu li a {
            color: white;
            text-decoration: none;
            display: block;
        }

        .content {
            margin-left: 250px;
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background-color: #1a2535;
        }

        .header {
            font-size: 28px;
            color: #dfe6e9;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .card {
            background-color: #162447;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .analysis-result {
            background-color: #0f1a2c;
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            line-height: 1.8;
            font-size: 16px;
            white-space: pre-wrap;
            color: #e0e0ff;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            min-height: 300px;
            text-align: left;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: #7f8fa6;
        }

        .error-message {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .button-container {
            margin-top: 20px;
            text-align: center;
        }

        .back-btn {
            background-color: #28a745;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition-duration: 0.4s;
        }

        .back-btn:hover {
            background-color: white;
            color: black;
            border: 2px solid #28a745;
        }
    </style>
</head>
<body>
<!-- 左侧菜单 -->
<div th:replace="fragments/menu :: menu"></div>

<!-- 右侧内容区域 -->
<div class="content">
    <h2 class="header">考试科目分析结果 - <span th:text="${subject}"></span></h2>

    <!-- 分析结果卡片 -->
    <div class="card">
        <div class="analysis-result" th:utext="${analysisResult} ?: '&lt;div class=&quot;loading&quot;&gt;&lt;i class=&quot;fas fa-spinner fa-spin&quot;&gt;&lt;/i&gt; 正在加载分析结果...&lt;/div&gt;'">
            <!-- 内容由Thymeleaf动态替换 -->
        </div>
    </div>

    <div class="button-container">
        <button class="back-btn" onclick="window.history.back()">返回</button>
    </div>
</div>

<script>
    // 添加简单的动画效果
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100 * index);
        });
    });
</script>

</body>
</html>
上述代码完成分析某个用户的参与的考试的结果，从用户参加过的所有考试的所有科目列表选中一个科目进行分析
请用Spring boot+MVC+Mybatis+vue进行重构，实体类不要动，服务类尽可能不要动，请给出完整的代码
